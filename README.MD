# EnergyGrid Data Aggregator

A robust Node.js client application for fetching telemetry data from 500 solar inverters while adhering to strict API rate limits and security requirements.

## ğŸ“‹ Project Overview

The **EnergyGrid Data Aggregator** is designed to efficiently collect real-time telemetry data from a fleet of 500 solar inverters (Serial Numbers `SN-000` to `SN-499`) through a RESTful API with the following constraints:

- **Batch Limit**: Maximum 10 serial numbers per POST request
- **Rate Limit**: Strictly 1 request per second (1000ms gap between requests)
- **Security**: Custom MD5 signature-based authentication
- **Resilience**: Automatic retry mechanism with exponential backoff

## ğŸ—ï¸ Architecture & Approach

### Core Components

1. **`utils.js`** - Utility functions for cryptographic operations and data manipulation
   - `generateSignature()` - MD5 hash generation for API authentication
   - `chunkArray()` - Splits device list into batches of 10
   - `sleep()` - Async delay for rate limiting

2. **`aggregator.js`** - Main orchestrator with retry logic and data aggregation
   - Handles batch processing
   - Implements rate limiting (1 req/sec)
   - Manages error handling and retries

### Solving the Rate Limit Challenge

To comply with the **1 request per second** constraint, we implemented:

```javascript
// Rate limiting: Wait 1 second before next request
if (i < batches.length - 1) {
  await sleep(RATE_LIMIT_MS); // 1000ms delay
}
```

**Result**: 50 batches processed in ~50 seconds with 0% rate limit violations.

### Batch Processing Strategy

To handle the **10-item batch limit**, we:

1. Generate 500 serial numbers (`SN-000` to `SN-499`)
2. Split them into 50 batches of 10 using `chunkArray()`
3. Process each batch sequentially with 1-second intervals

```javascript
const batches = chunkArray(allSerialNumbers, BATCH_SIZE); // BATCH_SIZE = 10
```

## ğŸ›¡ï¸ Resilience

### Exponential Backoff Strategy

The application implements a **3-tier exponential backoff** mechanism for handling transient failures:

| Attempt | Retry Delay | Use Case |
|---------|-------------|----------|
| 1st     | 1000ms (2^0 Ã— 1000) | Quick recovery from brief API hiccups |
| 2nd     | 2000ms (2^1 Ã— 1000) | Handle temporary server overload |
| 3rd     | 4000ms (2^2 Ã— 1000) | Final attempt before permanent failure |

```javascript
async function fetchBatchTelemetry(serialNumbers, retryCount = 0) {
  try {
    // ... API call
  } catch (error) {
    if (error.response?.status === 429 || error.code === 'ECONNREFUSED') {
      if (retryCount < MAX_RETRIES) {
        const backoffDelay = Math.pow(2, retryCount) * 1000;
        await sleep(backoffDelay);
        return fetchBatchTelemetry(serialNumbers, retryCount + 1);
      }
    }
    throw error;
  }
}
```

### Error Handling

- **429 Too Many Requests**: Automatic retry with backoff
- **Network Errors** (`ECONNREFUSED`): Retry mechanism
- **401 Unauthorized**: Signature validation failure (logged, not retried)
- **Batch Failures**: Logged but don't halt entire aggregation

## ğŸ” Security

### MD5 Signature Authentication

Every API request includes a custom `Signature` header computed as:

```
MD5(URL + SECRET_TOKEN + Timestamp)
```

**Implementation**:

```javascript
function generateSignature(url, token, timestamp) {
  const payload = `${url}${token}${timestamp}`;
  return crypto.createHash('md5').update(payload).digest('hex');
}
```

**Request Headers**:
```javascript
{
  'Content-Type': 'application/json',
  'Signature': 'c7591a8b5e1d4f6efb7e7e987ab8dc9d',
  'Timestamp': '1707028947966'
}
```

### Security Best Practices

- âœ… Secret token stored in `.env` (excluded from Git via `.gitignore`)
- âœ… Timestamp-based signature prevents replay attacks
- âœ… MD5 hash ensures request integrity

## ğŸš€ How to Run

### Prerequisites

- **Node.js** v14+ (with `crypto` built-in)
- **npm** (Node Package Manager)

### Installation

1. **Clone the repository**:
   ```bash
   git clone <repository-url>
   cd EnergyGrid-Data-Aggregator
   ```

2. **Install dependencies**:
   ```bash
   npm install
   ```
   This installs:
   - `axios` - HTTP client for API requests
   - `dotenv` - Environment variable management
   - `express` - (for mock server only)

3. **Configure environment**:
   
   Create a `.env` file in the project root:
   ```env
   SECRET_TOKEN=interview_token_123
   ```

### Running the Application

#### Option 1: Using the Mock Server (Testing)

**Terminal 1** - Start the mock API server:
```bash
node server.js
```
Expected output:
```
âš¡ EnergyGrid Mock API running on port 3000
   Constraints: 1 req/sec, Max 10 items/batch
```

**Terminal 2** - Run the aggregator:
```bash
node aggregator.js
```

#### Option 2: Production Environment

Set the `API_BASE_URL` environment variable:
```bash
export API_BASE_URL=https://api.energygrid.com  # Unix/Mac
# OR
$env:API_BASE_URL="https://api.energygrid.com"  # Windows PowerShell
```

Then run:
```bash
node aggregator.js
```

### Expected Output

```
ğŸš€ Starting EnergyGrid Data Aggregator...

ğŸ“¦ Total devices: 500
ğŸ“Š Batches to process: 50

[1/50] Fetching batch: SN-000 to SN-009
âœ… Success: 10 records retrieved
[2/50] Fetching batch: SN-010 to SN-019
âœ… Success: 10 records retrieved
...
[50/50] Fetching batch: SN-490 to SN-499
âœ… Success: 10 records retrieved

âœ¨ Aggregation Complete!
ğŸ“ˆ Total records fetched: 500/500
â±ï¸  Time elapsed: 49.83s

ğŸ“„ Sample data (first 3 records):
[
  {
    "sn": "SN-000",
    "power": "3.74 kW",
    "status": "Online",
    "last_updated": "2026-02-04T06:22:27.966Z"
  },
  ...
]
```

## ğŸ“Š Performance Metrics

| Metric | Value |
|--------|-------|
| **Total Devices** | 500 |
| **Batches Processed** | 50 |
| **Success Rate** | 100% |
| **Execution Time** | ~50 seconds |
| **Avg Time per Batch** | ~1 second |
| **Rate Limit Violations** | 0 |

## ğŸ“ Project Structure

```
EnergyGrid-Data-Aggregator/
â”œâ”€â”€ aggregator.js       # Main client application
â”œâ”€â”€ utils.js            # Utility functions (signature, chunking, sleep)
â”œâ”€â”€ server.js           # Mock API server (for testing)
â”œâ”€â”€ .env                # Environment variables (SECRET_TOKEN)
â”œâ”€â”€ .gitignore          # Excludes node_modules, .env, Implementation.md
â”œâ”€â”€ package.json        # Project dependencies
â””â”€â”€ README.md           # This file
```

## ğŸ§ª Testing

### Manual Testing Checklist

- [x] Verify signature generation matches server expectations
- [x] Test rate limiting (1 req/sec enforcement)
- [x] Validate batch size limit (max 10 items)
- [x] Confirm retry logic for 429 errors
- [x] Test full 500-device aggregation

### Running Tests

Start the mock server and aggregator in separate terminals:
```bash
# Terminal 1
node server.js

# Terminal 2
node aggregator.js
```

Observe server logs for:
- âœ… `[200] Success. Processed 10 devices.`
- âŒ `[429] Request rejected.` (should not appear with proper rate limiting)
- âŒ `[401] Bad Signature.` (should not appear with correct signature)

## ğŸ”§ Configuration

### Environment Variables

| Variable | Description | Default |
|----------|-------------|---------|
| `SECRET_TOKEN` | API authentication token | `interview_token_123` |
| `API_BASE_URL` | Base URL of the API endpoint | `http://localhost:3000` |

### Tunable Parameters (in `aggregator.js`)

```javascript
const BATCH_SIZE = 10;        // Max items per request (API constraint)
const RATE_LIMIT_MS = 1000;   // Delay between requests (1 req/sec)
const MAX_RETRIES = 3;        // Number of retry attempts
```

## ğŸ› Troubleshooting

### Issue: 401 Unauthorized Errors

**Cause**: Signature mismatch or missing `.env` file

**Solution**:
1. Verify `.env` file exists with `SECRET_TOKEN=interview_token_123`
2. Check that `dotenv` is properly loading (look for `injecting env (1)` in logs)
3. Ensure URL path is `/device/real/query` (not `/api/telemetry`)

### Issue: 429 Too Many Requests

**Cause**: Rate limit violation (requests too frequent)

**Solution**:
- The exponential backoff will automatically handle this
- If persistent, increase `RATE_LIMIT_MS` to > 1000ms

### Issue: ECONNREFUSED Error

**Cause**: Mock server not running

**Solution**:
```bash
node server.js  # Start the server first
```

## ğŸ“ Development Notes

### Why MD5?

While MD5 is cryptographically weak for password hashing, it's acceptable for **signature verification** in controlled environments where:
- The secret token is never transmitted
- Replay attacks are mitigated by timestamps
- The primary goal is request integrity, not cryptographic security

For production systems, consider upgrading to HMAC-SHA256.

### Why Sequential Batches?

Given the strict **1 req/sec** rate limit, parallel processing offers no benefit and risks rate limit violations. Sequential processing ensures:
- Predictable execution time (~50 seconds)
- Zero rate limit violations
- Simplified error handling

## ğŸ¯ Future Enhancements

- [ ] Add data persistence (save to JSON/CSV/Database)
- [ ] Implement progress bar for visual feedback
- [ ] Add unit tests with Jest
- [ ] Support concurrent execution with rate limiter library (e.g., `bottleneck`)
- [ ] Upgrade signature algorithm to HMAC-SHA256
- [ ] Add data validation and sanitization
- [ ] Implement graceful shutdown on Ctrl+C

## ğŸ“„ License

This project is part of an interview assignment for EnergyGrid Data Aggregator.

## ğŸ‘¥ Author

Built with â¤ï¸ for the EnergyGrid Assignment

---

**Status**: âœ… Production Ready | 100% Success Rate | Zero Rate Limit Violations